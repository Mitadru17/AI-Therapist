<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Therapist</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='images/favicon.svg') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <!-- Styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-brain"></i> AI Therapist</h1>
            </div>
            
            <button id="newChatBtn" class="new-chat-btn">
                <i class="fas fa-plus"></i> New Chat
            </button>
            
            <div class="sidebar-category">Chats</div>
            
            <div id="chatList" class="chat-list">
                <!-- Chat items will be loaded dynamically -->
                <div class="chat-item loading">
                    <div class="chat-icon"><i class="fas fa-spinner fa-spin"></i></div>
                    <div class="chat-title">Loading chats...</div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-profile" id="userProfile">
                    <div class="avatar">
                        <!-- Will be populated with user initials or image -->
                    </div>
                    <div class="user-name">
                        <!-- Will be populated with user name -->
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        
        <!-- Mobile sidebar toggle -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Tab Navigation -->
            <div class="tab-container">
                <div class="tab active" data-tab="chat">
                    <i class="fas fa-comment"></i> Chat
                </div>
                <div class="tab" data-tab="quotes">
                    <i class="fas fa-quote-right"></i> Quotes Collection
                </div>
                <div class="tab" data-tab="emergency">
                    <i class="fas fa-phone-alt"></i> Emergency Resources
                </div>
            </div>
            
            <!-- Content Area -->
            <div class="content-area">
                <!-- Chat Tab -->
                <div class="tab-content active" id="chat-tab">
                    <div class="chat-container">
                        <div class="chat-header">
                            <h2><i class="fas fa-comment"></i> Therapy Session</h2>
                            <div class="mood-indicator">
                                <span>Current mood: </span>
                                <span id="detectedMood" class="detected-mood">Listening...</span>
                            </div>
                            <button id="clearButton" class="action-btn">
                                <i class="fas fa-trash-alt"></i> Clear
                            </button>
                        </div>
                        
                        <div class="messages" id="messages">
                            <div class="message system">
                                <div class="message-content">
                                    Hello there! ðŸ‘‹ I'm your friendly AI Therapist, here to support you on your journey.
                                    <br><br>
                                    Feel free to share what's on your mind, and I'll listen and respond to how you're feeling.
                                    <br><br>
                                    I'm here to help. ðŸ’–
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-area">
                            <input type="text" id="userInput" placeholder="Type a message..." autofocus>
                            <button id="sendButton" class="send-btn">
                                Send <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Quotes Tab -->
                <div class="tab-content" id="quotes-tab">
                    <div class="quotes-container">
                        <div class="quotes-header">
                            <h2><i class="fas fa-quote-right"></i> Your Inspirational Quotes</h2>
                            <button id="quoteButton" class="get-quote-btn">
                                <i class="fas fa-plus"></i> New Quote
                            </button>
                        </div>
                        
                        <div class="quote-grid" id="quoteBubbles">
                            <!-- Quotes will be added here dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Emergency Resources Tab -->
                <div class="tab-content" id="emergency-tab">
                    <div class="emergency-container">
                        <div class="emergency-header">
                            <h2><i class="fas fa-phone-alt"></i> Emergency Resources</h2>
                            <div class="emergency-message">
                                If you're experiencing thoughts of harming yourself or feeling overwhelmed, please reach out for help immediately. You're not alone.
                            </div>
                        </div>
                        
                        <div class="resources-grid" id="emergencyResources">
                            <!-- Emergency resources will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize Firebase
            try {
                // Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyD3o-K0laghfbJNA11ubUhbHV7hNDNx8Cg",
                    authDomain: "ai-therapist-30c16.firebaseapp.com",
                    projectId: "ai-therapist-30c16",
                    storageBucket: "ai-therapist-30c16.appspot.com",
                    messagingSenderId: "359622442079",
                    appId: "1:359622442079:web:ebba5c45af2b46a9a69a35"
                };
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                
                // Get current user
                const currentUser = firebase.auth().currentUser;
                
                // If user is not signed in, redirect to sign-in page
                if (!currentUser && !firebase.auth().isSignInWithEmailLink(window.location.href)) {
                    // Check if user is signed in
                    const authChecked = await new Promise((resolve) => {
                        firebase.auth().onAuthStateChanged((user) => {
                            resolve(!!user);
                        });
                    });
                    
                    // If after the auth state check user is still not signed in, redirect
                    if (!authChecked) {
                        console.log("No authenticated user, redirecting to sign-in");
                        window.location.href = "/sign-in";
                        return;
                    }
                }
                
                // Continue with app initialization now that we know user is authenticated
                await initializeApp();
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                // Redirect to sign-in on error
                window.location.href = "/sign-in";
            }
            
            // Initialize the main application
            async function initializeApp() {
                // First check server-side authentication status
                try {
                    const authResponse = await fetch('/api/verify-auth');
                    if (!authResponse.ok) {
                        throw new Error('Authentication verification failed');
                    }
                    
                    const authData = await authResponse.json();
                    
                    // If backend shows not signed in but Firebase thinks we are, synchronize by signing out
                    if (!authData.isSignedIn && firebase.auth().currentUser) {
                        console.warn('Authentication state mismatch - signing out from Firebase');
                        await firebase.auth().signOut();
                        window.location.href = '/sign-in';
                        return;
                    }
                    
                    // If backend shows signed in but Firebase doesn't, redirect to sign-in
                    if (authData.isSignedIn && !firebase.auth().currentUser) {
                        console.warn('Authentication state mismatch - redirecting to sign-in');
                        window.location.href = '/sign-in';
                        return;
                    }
                } catch (error) {
                    console.error('Error verifying authentication:', error);
                    window.location.href = '/sign-in';
                    return;
                }
                
                // UI Elements
                const messagesContainer = document.getElementById('messages');
                const userInput = document.getElementById('userInput');
                const sendButton = document.getElementById('sendButton');
                const detectedMood = document.getElementById('detectedMood');
                const clearButton = document.getElementById('clearButton');
                const quoteBubbles = document.getElementById('quoteBubbles');
                const quoteButton = document.getElementById('quoteButton');
                const emergencyResources = document.getElementById('emergencyResources');
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
                const sidebarToggle = document.getElementById('sidebarToggle');
                const sidebar = document.querySelector('.sidebar');
                const chatList = document.getElementById('chatList');
                const newChatBtn = document.getElementById('newChatBtn');
                const userProfile = document.getElementById('userProfile');
                const logoutBtn = document.getElementById('logoutBtn');
                
                // State variables
                let currentMood = "neutral";
                let isEmergency = false;
                let chatHistory = [];
                let currentChatId = null;
                
                // Set up user data and logout
                function setupUser() {
                    const user = firebase.auth().currentUser;
                    if (user) {
                        // Set user avatar
                        const avatarElement = userProfile.querySelector('.avatar');
                        if (user.photoURL) {
                            avatarElement.innerHTML = `<img src="${user.photoURL}" alt="User avatar">`;
                            avatarElement.classList.add('has-image');
                        } else {
                            // Get user initials
                            const displayName = user.displayName || user.email || '';
                            const nameParts = displayName.split(' ');
                            let initials = '';
                            if (nameParts.length > 0) {
                                initials += nameParts[0].charAt(0).toUpperCase();
                                if (nameParts.length > 1) {
                                    initials += nameParts[nameParts.length - 1].charAt(0).toUpperCase();
                                }
                            }
                            if (!initials) initials = 'U'; // Default if no name/email
                            avatarElement.innerText = initials;
                        }
                        
                        // Set user name
                        const userNameElement = userProfile.querySelector('.user-name');
                        userNameElement.innerText = user.displayName || user.email.split('@')[0] || 'User';
                        
                        // Set up logout button
                        logoutBtn.addEventListener('click', function() {
                            firebase.auth().signOut().then(() => {
                                // Clear session cookie
                                document.cookie = '__session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                                window.location.href = '/sign-in';
                            }).catch((error) => {
                                console.error('Error signing out:', error);
                            });
                        });
                    } else {
                        // Redirect to sign-in if no user
                        window.location.href = '/sign-in';
                    }
                }
                
                // Call setup function
                setupUser();
                
                // Mobile sidebar toggle functionality
                function checkWindowSize() {
                    if (window.innerWidth <= 992) {
                        sidebarToggle.style.display = 'flex';
                    } else {
                        sidebarToggle.style.display = 'none';
                        sidebar.classList.remove('active');
                    }
                }
                
                window.addEventListener('resize', checkWindowSize);
                checkWindowSize(); // Check on load
                
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
                
                // Send message function
                function sendMessage() {
                    const messageText = userInput.value.trim();
                    if (!messageText || !currentChatId) return;
                    
                    // Clear input
                    userInput.value = '';
                    
                    // Show user message immediately
                    const userMessageDiv = document.createElement('div');
                    userMessageDiv.className = 'message user';
                    userMessageDiv.innerHTML = `<div class="message-content">${messageText}</div>`;
                    messagesContainer.appendChild(userMessageDiv);
                    
                    // Add loading message
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'message bot';
                    loadingDiv.innerHTML = `
                        <div class="message-content">
                            <div class="typing-animation">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                        </div>
                    `;
                    messagesContainer.appendChild(loadingDiv);
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Send message to API
                    fetch(`/api/chats/${currentChatId}/messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: messageText
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        // Remove loading message
                        messagesContainer.removeChild(loadingDiv);
                        
                        // Add bot response
                        const botMessageDiv = document.createElement('div');
                        botMessageDiv.className = 'message bot';
                        botMessageDiv.innerHTML = `<div class="message-content">${data.message.text}</div>`;
                        messagesContainer.appendChild(botMessageDiv);
                        
                        // Scroll to bottom
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        // Update mood if available
                        if (data.detected_mood) {
                            currentMood = data.detected_mood;
                            updateMoodDisplay(currentMood);
                        }
                        
                        // Show emergency resources if emergency detected
                        if (data.is_emergency && data.resources && data.resources.length > 0) {
                            displayStaticEmergencyResources(data.resources);
                            
                            // Show a notification to check emergency resources
                            const emergencyNotice = document.createElement('div');
                            emergencyNotice.className = 'message system';
                            emergencyNotice.innerHTML = `
                                <div class="message-content" style="background-color: #FEF2F2; color: #B91C1C;">
                                    <strong>Important:</strong> I've noticed some concerning content in our conversation. 
                                    Please check the Emergency Resources tab for support options that might help.
                                </div>
                            `;
                            messagesContainer.appendChild(emergencyNotice);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        
                        // Remove loading message
                        messagesContainer.removeChild(loadingDiv);
                        
                        // Show error message
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'message system';
                        errorDiv.innerHTML = `
                            <div class="message-content">
                                <strong>Error:</strong> Failed to send message. Please try again.
                            </div>
                        `;
                        messagesContainer.appendChild(errorDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    });
                }
                
                // Add event listeners for sending messages
                sendButton.addEventListener('click', sendMessage);
                
                // Add keypress event listener for Enter key
                userInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Clear button functionality
                clearButton.addEventListener('click', function() {
                    if (confirm('Clear this conversation? This cannot be undone.')) {
                        // Create a new chat and switch to it
                        createNewChat();
                    }
                });
                
                // Load all chats from the API
                function loadChats() {
                    // Show loading state
                    chatList.innerHTML = `
                        <div class="chat-item loading">
                            <div class="chat-icon"><i class="fas fa-spinner fa-spin"></i></div>
                            <div class="chat-title">Loading chats...</div>
                        </div>
                    `;
                    
                    fetch('/api/chats')
                        .then(response => response.json())
                        .then(chats => {
                            chatList.innerHTML = ''; // Clear loading state
                            
                            if (chats.length === 0) {
                                // If no chats exist, create a new one
                                createNewChat();
                                return;
                            }
                            
                            // Add each chat to the list
                            chats.forEach(chat => {
                                addChatToList(chat);
                            });
                            
                            // Select the first chat by default
                            if (chats.length > 0 && !currentChatId) {
                                selectChat(chats[0].id);
                            }
                        })
                        .catch(error => {
                            console.error('Error loading chats:', error);
                            chatList.innerHTML = `
                                <div class="chat-item error">
                                    <div class="chat-icon"><i class="fas fa-exclamation-circle"></i></div>
                                    <div class="chat-title">Error loading chats</div>
                                </div>
                            `;
                        });
                }
                
                // Add a chat to the sidebar list
                function addChatToList(chat) {
                    const chatItem = document.createElement('div');
                    chatItem.className = `chat-item${chat.id === currentChatId ? ' active' : ''}`;
                    chatItem.dataset.chatId = chat.id;
                    
                    chatItem.innerHTML = `
                        <div class="chat-icon"><i class="fas fa-comment"></i></div>
                        <div class="chat-title">${chat.title}</div>
                        <button class="delete-chat" title="Delete chat"><i class="fas fa-trash"></i></button>
                    `;
                    
                    // Add click event to select the chat
                    chatItem.addEventListener('click', function() {
                        selectChat(chat.id);
                    });
                    
                    // Add click event to delete button
                    const deleteBtn = chatItem.querySelector('.delete-chat');
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent chat selection when deleting
                        if (confirm('Are you sure you want to delete this chat?')) {
                            deleteChat(chat.id);
                        }
                    });
                    
                    chatList.appendChild(chatItem);
                }
                
                // Select a chat and load its messages
                function selectChat(chatId) {
                    // Update UI for selected chat
                    document.querySelectorAll('.chat-item').forEach(item => {
                        item.classList.remove('active');
                        if (item.dataset.chatId === chatId) {
                            item.classList.add('active');
                        }
                    });
                    
                    // If selecting the same chat, do nothing
                    if (chatId === currentChatId) {
                        return;
                    }
                    
                    currentChatId = chatId;
                    
                    // Clear current messages
                    messagesContainer.innerHTML = '';
                    chatHistory = [];
                    
                    // Show loading indicator
                    const loadingMsg = document.createElement('div');
                    loadingMsg.className = 'message system';
                    loadingMsg.innerHTML = `
                        <div class="message-content">
                            <div class="typing-animation">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                        </div>
                    `;
                    messagesContainer.appendChild(loadingMsg);
                    
                    // Load chat messages
                    fetch(`/api/chats/${chatId}`)
                        .then(response => response.json())
                        .then(chat => {
                            // Clear loading indicator
                            messagesContainer.innerHTML = '';
                            
                            // Update chat history
                            chatHistory = chat.messages || [];
                            
                            // Display messages
                            chatHistory.forEach(msg => {
                                const messageDiv = document.createElement('div');
                                messageDiv.className = `message ${msg.sender}`;
                                
                                const contentDiv = document.createElement('div');
                                contentDiv.className = 'message-content';
                                contentDiv.textContent = msg.text;
                                
                                messageDiv.appendChild(contentDiv);
                                messagesContainer.appendChild(messageDiv);
                            });
                            
                            // Scroll to bottom
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            
                            // Set the chat title in header
                            document.querySelector('.chat-header h2').innerHTML = `<i class="fas fa-comment"></i> ${chat.title}`;
                            
                            // Update detected mood if available
                            const lastBotMessage = chatHistory.filter(msg => msg.sender === 'bot').pop();
                            if (lastBotMessage) {
                                // Simple mood extraction from bot responses
                                if (lastBotMessage.text.includes('ðŸ˜„') || lastBotMessage.text.includes('happy')) {
                                    currentMood = 'happy';
                                } else if (lastBotMessage.text.includes('ðŸ˜”') || lastBotMessage.text.includes('sad')) {
                                    currentMood = 'sad';
                                } else if (lastBotMessage.text.includes('ðŸ˜°') || lastBotMessage.text.includes('anxious')) {
                                    currentMood = 'anxious';
                                } else if (lastBotMessage.text.includes('ðŸ˜ ') || lastBotMessage.text.includes('angry')) {
                                    currentMood = 'angry';
                                } else {
                                    currentMood = 'neutral';
                                }
                                updateMoodDisplay(currentMood);
                            }
                            
                            // Switch to chat tab
                            tabs.forEach(t => t.classList.remove('active'));
                            tabs[0].classList.add('active');
                            
                            tabContents.forEach(content => {
                                content.classList.remove('active');
                            });
                            document.getElementById('chat-tab').classList.add('active');
                        })
                        .catch(error => {
                            console.error('Error loading chat:', error);
                            messagesContainer.innerHTML = `
                                <div class="message system">
                                    <div class="message-content">
                                        <strong>Error:</strong> Failed to load chat messages. Please try again or start a new chat.
                                    </div>
                                </div>
                            `;
                        });
                }
                
                // Create a new chat
                function createNewChat() {
                    fetch('/api/chats/new', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: 'New Chat'
                        })
                    })
                    .then(response => response.json())
                    .then(chat => {
                        // Add to sidebar
                        addChatToList(chat);
                        
                        // Select the new chat
                        selectChat(chat.id);
                        
                        // Close sidebar on mobile
                        if (window.innerWidth <= 992) {
                            sidebar.classList.remove('active');
                        }
                    })
                    .catch(error => {
                        console.error('Error creating new chat:', error);
                        alert('Failed to create a new chat. Please try again.');
                    });
                }
                
                // Delete a chat
                function deleteChat(chatId) {
                    fetch(`/api/chats/${chatId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            // Remove from sidebar
                            const chatItem = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                            if (chatItem) {
                                chatItem.remove();
                            }
                            
                            // If we deleted the current chat, load another one
                            if (chatId === currentChatId) {
                                const firstChatItem = document.querySelector('.chat-item');
                                if (firstChatItem) {
                                    selectChat(firstChatItem.dataset.chatId);
                                } else {
                                    // If no chats left, create a new one
                                    createNewChat();
                                }
                            }
                        } else {
                            console.error('Error deleting chat:', result.error);
                            alert('Failed to delete the chat. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting chat:', error);
                        alert('Failed to delete the chat. Please try again.');
                    });
                }
                
                // New chat button event
                newChatBtn.addEventListener('click', createNewChat);
                
                // Handle tab switching
                tabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const tabId = this.getAttribute('data-tab');
                        
                        // Update active tab
                        tabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Show corresponding content
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                        });
                        document.getElementById(`${tabId}-tab`).classList.add('active');
                    });
                });
                
                // Emoji mapping for moods
                const moodEmojis = {
                    'happy': 'ðŸ˜„',
                    'sad': 'ðŸ˜”',
                    'anxious': 'ðŸ˜°',
                    'angry': 'ðŸ˜ ',
                    'neutral': 'ðŸ˜Š'
                };
                
                // Update the detected mood display
                function updateMoodDisplay(mood) {
                    const emoji = moodEmojis[mood] || 'ðŸ˜Š';
                    detectedMood.textContent = `${emoji} ${mood.charAt(0).toUpperCase() + mood.slice(1)}`;
                    
                    // Add a transition effect for mood changes
                    detectedMood.classList.add('mood-change');
                    setTimeout(() => {
                        detectedMood.classList.remove('mood-change');
                    }, 500);
                    
                    // Add a visual indicator based on mood
                    document.documentElement.style.setProperty('--primary-color', getMoodColor(mood));
                    document.documentElement.style.setProperty('--primary-dark', getDarkerColor(getMoodColor(mood)));
                }
                
                // Get color based on mood
                function getMoodColor(mood) {
                    switch(mood) {
                        case 'happy': return '#4CAF50';
                        case 'sad': return '#5B6EF5';
                        case 'anxious': return '#9C27B0';
                        case 'angry': return '#F44336';
                        default: return '#5B6EF5';
                    }
                }
                
                // Get darker shade of a color
                function getDarkerColor(hexColor) {
                    // Convert hex to RGB
                    let r = parseInt(hexColor.slice(1, 3), 16);
                    let g = parseInt(hexColor.slice(3, 5), 16);
                    let b = parseInt(hexColor.slice(5, 7), 16);
                    
                    // Make darker by reducing each component by 15%
                    r = Math.max(0, Math.floor(r * 0.85));
                    g = Math.max(0, Math.floor(g * 0.85));
                    b = Math.max(0, Math.floor(b * 0.85));
                    
                    // Convert back to hex
                    return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
                }
                
                // Initially load emergency resources
                function loadEmergencyResources() {
                    fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: "Show me emergency resources",
                            is_emergency: true
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.resources && data.resources.length > 0) {
                            displayStaticEmergencyResources(data.resources);
                        }
                    })
                    .catch(error => console.error('Error loading emergency resources:', error));
                }
                
                // Display emergency resources in the emergency tab
                function displayStaticEmergencyResources(resources) {
                    emergencyResources.innerHTML = '';
                    
                    resources.forEach(resource => {
                        const resourceCard = document.createElement('div');
                        resourceCard.className = 'resource-card';
                        
                        resourceCard.innerHTML = `
                            <div class="resource-name">${resource.name}</div>
                            <div class="resource-contact">${resource.contact}</div>
                            <div class="resource-description">${resource.description}</div>
                        `;
                        
                        emergencyResources.appendChild(resourceCard);
                    });
                }
                
                // Load chats, emergency resources, and quotes
                loadChats();
                loadEmergencyResources();
                
                // Load some initial quotes after a delay
                setTimeout(() => {
                    // First try to load existing quotes
                    loadQuotes();
                    
                    // Then get a new quote if no quotes exist
                    setTimeout(() => {
                        if (document.querySelectorAll('.quote-bubble').length === 0) {
                            getNewQuote();
                        }
                    }, 500);
                }, 1000);
                
                // Function to load quotes from API
                function loadQuotes() {
                    fetch('/api/quotes')
                        .then(response => response.json())
                        .then(quotes => {
                            // Clear existing quotes
                            quoteBubbles.innerHTML = '';
                            
                            // Add each quote to the grid
                            quotes.forEach(quote => {
                                addQuoteCard(quote);
                            });
                        })
                        .catch(error => {
                            console.error('Error loading quotes:', error);
                        });
                }
                
                // Function to get a new quote
                function getNewQuote() {
                    fetch('/quote', { method: 'GET', headers: { 'Content-Type': 'application/json' } })
                        .then(response => response.json())
                        .then(quoteData => { 
                            if (quoteData.text) {
                                addQuoteCard(quoteData); 
                            }
                        })
                        .catch(error => {
                            console.error('Error getting quote:', error);
                        });
                }
                
                // Function to add a quote card to the grid
                function addQuoteCard(quoteData) {
                    const quoteText = quoteData.text;
                    const quoteId = quoteData.id || '';
                    
                    const quoteBubble = document.createElement('div');
                    quoteBubble.className = 'quote-bubble';
                    quoteBubble.dataset.quoteId = quoteId;
                    
                    // Create delete button for quote
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-quote';
                    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                    deleteBtn.title = 'Delete quote';
                    
                    // Add click event to delete button
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent bubble selection
                        if (quoteId && confirm('Delete this quote?')) {
                            deleteQuote(quoteId, quoteBubble);
                        } else if (!quoteId) {
                            // If no ID (local only), just remove from DOM
                            quoteBubble.remove();
                        }
                    });
                    
                    // Create quote text element
                    const quoteContent = document.createElement('div');
                    quoteContent.className = 'quote-text';
                    quoteContent.textContent = quoteText;
                    
                    // Add elements to bubble
                    quoteBubble.appendChild(deleteBtn);
                    quoteBubble.appendChild(quoteContent);
                    
                    // Add to grid
                    quoteBubbles.appendChild(quoteBubble);
                }
                
                // Function to delete a quote
                function deleteQuote(quoteId, quoteBubble) {
                    fetch(`/api/quotes/${quoteId}`, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                quoteBubble.remove();
                            } else {
                                console.error('Error deleting quote:', result.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting quote:', error);
                        });
                }
                
                // Quote button event
                quoteButton.addEventListener('click', getNewQuote);
            }
        });
    </script>
</body>
</html> 